<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ENTROPY</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;cursor:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAAgElEQVRYhe3WWwqAIBCF4WO0kNn/qtxJvXRALEjCuRjzQy8Z1HxEBgDHdbi0ed2YFdynL5YPEEeg1goAEJF2Tb14AsxKIq4A05aIL8C0JNYRYLMl1hNgsyTcBfbRC5uJ+7ibfpKIK8CJH96Nn34HunOA0S4ZQuAt1X9Gd4Esy7ITJLQliU3gx1UAAAAASUVORK5CYII=') 0 0, auto}
html,body{width:100%;height:100%;background:#000;overflow:hidden;image-rendering:pixelated;font-family:monospace}
canvas{display:block;width:100%;height:100%;image-rendering:pixelated;image-rendering:crisp-edges}
</style>
</head>
<body>
<canvas id="c"></canvas>

<script>
(function(){
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
const GW=384,GH=256,SCALE=2;
canvas.width=GW*SCALE;canvas.height=GH*SCALE;

let state=null,globalEntropy=63,tick=0;

// ===== PALETTE =====
const PAL={
  sky:['#4a8fb8','#3a7fa8','#2a5f78','#1a3f58','#0f1f2f'],
  grass:['#3a7a3a','#2d6a2d','#1f5a1f'],
  grassDead:['#6a5a2a','#5a4a1f','#4a3a15'],
  path:'#c8b888',pathDark:'#a89868',
  wood:'#8a6a3a',woodDark:'#6a4a2a',
  roof:'#b83a3a',roofBlue:'#3a5a8a',roofPurple:'#6a3a8a',roofGreen:'#3a6a3a',roofGold:'#8a7a2a',
};

// ===== PIXEL FONT =====
const FONT={
  'A':[[0,1,1,0],[1,0,0,1],[1,1,1,1],[1,0,0,1],[1,0,0,1]],
  'B':[[1,1,1,0],[1,0,0,1],[1,1,1,0],[1,0,0,1],[1,1,1,0]],
  'C':[[0,1,1,1],[1,0,0,0],[1,0,0,0],[1,0,0,0],[0,1,1,1]],
  'D':[[1,1,1,0],[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,1,1,0]],
  'E':[[1,1,1,1],[1,0,0,0],[1,1,1,0],[1,0,0,0],[1,1,1,1]],
  'F':[[1,1,1,1],[1,0,0,0],[1,1,1,0],[1,0,0,0],[1,0,0,0]],
  'G':[[0,1,1,1],[1,0,0,0],[1,0,1,1],[1,0,0,1],[0,1,1,0]],
  'H':[[1,0,0,1],[1,0,0,1],[1,1,1,1],[1,0,0,1],[1,0,0,1]],
  'I':[[1,1,1],[0,1,0],[0,1,0],[0,1,0],[1,1,1]],
  'J':[[0,0,1],[0,0,1],[0,0,1],[1,0,1],[0,1,0]],
  'K':[[1,0,0,1],[1,0,1,0],[1,1,0,0],[1,0,1,0],[1,0,0,1]],
  'L':[[1,0,0,0],[1,0,0,0],[1,0,0,0],[1,0,0,0],[1,1,1,1]],
  'M':[[1,0,0,0,1],[1,1,0,1,1],[1,0,1,0,1],[1,0,0,0,1],[1,0,0,0,1]],
  'N':[[1,0,0,1],[1,1,0,1],[1,0,1,1],[1,0,0,1],[1,0,0,1]],
  'O':[[0,1,1,0],[1,0,0,1],[1,0,0,1],[1,0,0,1],[0,1,1,0]],
  'P':[[1,1,1,0],[1,0,0,1],[1,1,1,0],[1,0,0,0],[1,0,0,0]],
  'Q':[[0,1,1,0],[1,0,0,1],[1,0,0,1],[1,0,1,0],[0,1,0,1]],
  'R':[[1,1,1,0],[1,0,0,1],[1,1,1,0],[1,0,1,0],[1,0,0,1]],
  'S':[[0,1,1,1],[1,0,0,0],[0,1,1,0],[0,0,0,1],[1,1,1,0]],
  'T':[[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0]],
  'U':[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[0,1,1,0]],
  'V':[[1,0,0,0,1],[1,0,0,0,1],[0,1,0,1,0],[0,1,0,1,0],[0,0,1,0,0]],
  'W':[[1,0,0,0,1],[1,0,0,0,1],[1,0,1,0,1],[1,1,0,1,1],[1,0,0,0,1]],
  'X':[[1,0,0,1],[0,1,1,0],[0,1,1,0],[0,1,1,0],[1,0,0,1]],
  'Y':[[1,0,0,0,1],[0,1,0,1,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0]],
  'Z':[[1,1,1,1],[0,0,1,0],[0,1,0,0],[1,0,0,0],[1,1,1,1]],
  '0':[[0,1,1,0],[1,0,0,1],[1,0,0,1],[1,0,0,1],[0,1,1,0]],
  '1':[[0,1,0],[1,1,0],[0,1,0],[0,1,0],[1,1,1]],
  '2':[[0,1,1,0],[1,0,0,1],[0,0,1,0],[0,1,0,0],[1,1,1,1]],
  '3':[[1,1,1,0],[0,0,0,1],[0,1,1,0],[0,0,0,1],[1,1,1,0]],
  '4':[[1,0,0,1],[1,0,0,1],[1,1,1,1],[0,0,0,1],[0,0,0,1]],
  '5':[[1,1,1,1],[1,0,0,0],[1,1,1,0],[0,0,0,1],[1,1,1,0]],
  '6':[[0,1,1,0],[1,0,0,0],[1,1,1,0],[1,0,0,1],[0,1,1,0]],
  '7':[[1,1,1,1],[0,0,0,1],[0,0,1,0],[0,1,0,0],[0,1,0,0]],
  '8':[[0,1,1,0],[1,0,0,1],[0,1,1,0],[1,0,0,1],[0,1,1,0]],
  '9':[[0,1,1,0],[1,0,0,1],[0,1,1,1],[0,0,0,1],[0,1,1,0]],
  '%':[[1,0,0,1],[0,0,1,0],[0,1,0,0],[1,0,0,1],[0,0,0,0]],
  '/':[[0,0,1],[0,0,1],[0,1,0],[1,0,0],[1,0,0]],
  '.':[[0],[0],[0],[0],[1]],':':[[0],[1],[0],[1],[0]],
  '-':[[0,0,0],[0,0,0],[1,1,1],[0,0,0],[0,0,0]],
  ' ':[[0,0],[0,0],[0,0],[0,0],[0,0]],
  '!':[[1],[1],[1],[0],[1]],'?':[[0,1,1,0],[1,0,0,1],[0,0,1,0],[0,0,0,0],[0,0,1,0]],
  "'":[[1],[1],[0],[0],[0]],
  '+':[[0,0,0],[0,1,0],[1,1,1],[0,1,0],[0,0,0]],
  '(':[[0,1],[1,0],[1,0],[1,0],[0,1]],')':[[1,0],[0,1],[0,1],[0,1],[1,0]],
};

function drawText(str,x,y,color,scale=1){
  str=str.toUpperCase();let cx=x;
  for(const ch of str){
    const g=FONT[ch];if(!g){cx+=4*scale;continue}
    for(let r=0;r<g.length;r++)for(let c=0;c<g[r].length;c++){
      if(g[r][c]){ctx.fillStyle=color;ctx.fillRect(cx+c*scale,y+r*scale,scale,scale);}
    }
    cx+=g[0].length*scale+scale;
  }return cx-x;
}
function textWidth(str,scale=1){
  str=str.toUpperCase();let w=0;
  for(const ch of str){const g=FONT[ch];w+=(g?g[0].length:3)*scale+scale;}
  return w-scale;
}
function getColor(pct){
  if(pct<30)return'#40a840';if(pct<50)return'#d0b030';if(pct<70)return'#e07020';return'#e83030';
}

// ===== BUILDINGS =====
const BUILDINGS=[
  {id:'twitter-main',name:'TWITTER',bx:60,by:50,w:28,h:22,roof:PAL.roofBlue,color:[120,170,220]},
  {id:'crypto-twitter',name:'CRYPTO',bx:140,by:35,w:28,h:22,roof:PAL.roofGold,color:[240,190,50]},
  {id:'ai-twitter',name:'AI',bx:220,by:50,w:28,h:22,roof:'#b83a3a',color:[100,200,255]},
  {id:'politics',name:'POLITICS',bx:300,by:40,w:28,h:22,roof:'#b83a3a',color:[100,100,140]},
  {id:'reddit-all',name:'REDDIT',bx:40,by:120,w:28,h:22,roof:PAL.roofBlue,color:[255,130,60]},
  {id:'wallstreetbets',name:'WSB',bx:120,by:135,w:28,h:22,roof:PAL.roofGold,color:[200,170,50]},
  {id:'reddit-ml',name:'R/ML',bx:200,by:120,w:28,h:22,roof:PAL.roofPurple,color:[180,180,220]},
  {id:'gaming',name:'GAMING',bx:280,by:130,w:28,h:22,roof:PAL.roofGreen,color:[80,200,120]},
  {id:'twitch',name:'TWITCH',bx:80,by:190,w:28,h:22,roof:PAL.roofPurple,color:[145,70,255]},
  {id:'tech-twitter',name:'TECH',bx:170,by:195,w:28,h:22,roof:PAL.roofBlue,color:[60,180,180]},
  {id:'reddit-politics',name:'R/POL',bx:250,by:185,w:28,h:22,roof:'#b83a3a',color:[255,100,50]},
  {id:'media',name:'NEWS',bx:330,by:195,w:28,h:22,roof:'#b83a3a',color:[180,180,180]},
];

// ===== PATH NETWORK (for NPC walking) =====
// Waypoints on paths - NPCs walk between these
const WAYPOINTS=[
  {x:40,y:93},{x:75,y:93},{x:155,y:93},{x:235,y:93},{x:310,y:93},{x:360,y:93},
  {x:40,y:168},{x:75,y:168},{x:155,y:168},{x:235,y:168},{x:310,y:168},{x:360,y:168},
  {x:75,y:60},{x:75,y:130},{x:155,y:45},{x:155,y:140},{x:235,y:60},{x:235,y:130},{x:310,y:50},{x:310,y:140},
];

// ===== WALKING NPCs =====
const walkers=[];
function initWalkers(){
  for(let i=0;i<8;i++){
    const fromIdx=Math.floor(Math.random()*WAYPOINTS.length);
    let toIdx=Math.floor(Math.random()*WAYPOINTS.length);
    while(toIdx===fromIdx) toIdx=Math.floor(Math.random()*WAYPOINTS.length);
    const bIdx=Math.floor(Math.random()*BUILDINGS.length);
    walkers.push({
      x:WAYPOINTS[fromIdx].x,y:WAYPOINTS[fromIdx].y,
      tx:WAYPOINTS[toIdx].x,ty:WAYPOINTS[toIdx].y,
      speed:0.2+Math.random()*0.3,
      color:BUILDINGS[bIdx].color,
      buildingIdx:bIdx,
      waitTimer:0,
      dir:1, // 1=right, -1=left
    });
  }
}

function updateWalkers(){
  for(const w of walkers){
    if(w.waitTimer>0){w.waitTimer--;continue;}
    const dx=w.tx-w.x,dy=w.ty-w.y;
    const dist=Math.sqrt(dx*dx+dy*dy);
    if(dist<2){
      // Pick new target
      const idx=Math.floor(Math.random()*WAYPOINTS.length);
      w.tx=WAYPOINTS[idx].x;w.ty=WAYPOINTS[idx].y;
      w.waitTimer=60+Math.floor(Math.random()*120); // pause 1-3 sec
      return;
    }
    const mx=dx/dist*w.speed;
    const my=dy/dist*w.speed;
    w.x+=mx;w.y+=my;
    w.dir=mx>=0?1:-1;
  }
}

function drawWalker(w,t){
  const b=BUILDINGS[w.buildingIdx];
  const node=state?state.nodes.find(n=>n.id===b.id):null;
  const infection=node?node.infection:50;
  const inf=infection/100;
  const bob=w.waitTimer>0?0:Math.floor(Math.sin(t/150+w.x)*1);
  const x=Math.floor(w.x),y=Math.floor(w.y)+bob;
  const r=w.color[0],g=w.color[1],bl=w.color[2];
  const cr=Math.min(255,Math.floor(r+(230-r)*inf*0.7));
  const cg=Math.floor(g*(1-inf*0.6));
  const cb=Math.floor(bl*(1-inf*0.7));
  const col=`rgb(${cr},${cg},${cb})`;
  const dark=`rgb(${Math.floor(cr*0.6)},${Math.floor(cg*0.6)},${Math.floor(cb*0.6)})`;

  // Walk animation - alternate legs
  const step=w.waitTimer>0?0:Math.floor(t/200)%2;

  // Shadow
  ctx.fillStyle='rgba(0,0,0,0.25)';
  ctx.fillRect(x,y+8,7,1);

  // Head
  ctx.fillStyle=col;ctx.fillRect(x+1,y-2,5,4);
  ctx.fillStyle=dark;ctx.fillRect(x,y-1,1,2);ctx.fillRect(x+6,y-1,1,2);
  // Eyes
  if(inf>0.5){ctx.fillStyle=`rgba(255,30,0,${0.7+0.3*Math.sin(t/200)})`;} else {ctx.fillStyle='#fff';}
  ctx.fillRect(x+2,y,1,1);ctx.fillRect(x+4,y,1,1);
  // Body
  ctx.fillStyle=col;ctx.fillRect(x+1,y+3,5,3);
  // Legs
  ctx.fillStyle=dark;
  if(step===0){ctx.fillRect(x+1,y+6,2,2);ctx.fillRect(x+4,y+6,2,2);}
  else{ctx.fillRect(x+2,y+6,2,2);ctx.fillRect(x+3,y+6,2,2);}
  // Glitch
  if(inf>0.7&&Math.random()<0.05){
    ctx.fillStyle=`rgba(255,0,0,0.5)`;ctx.fillRect(x-1+Math.random()*8,y-2+Math.random()*10,2,1);
  }
}

// ===== WEATHER PARTICLES =====
const weatherParticles=[];
function initWeather(){
  for(let i=0;i<150;i++){
    weatherParticles.push({x:Math.random()*GW,y:Math.random()*GH,speed:1+Math.random()*2,size:1});
  }
}

function updateWeather(){
  const inf=globalEntropy/100;
  for(const p of weatherParticles){
    if(inf>0.4){
      // Rain
      p.y+=p.speed;
      p.x-=0.3;
      if(p.y>GH-20){p.y=24;p.x=Math.random()*GW;}
      if(p.x<0)p.x=GW;
    }
    if(inf>0.8){
      // Fire embers rise
      p.y-=p.speed*0.5;
      p.x+=Math.sin(p.y/20)*0.5;
      if(p.y<24){p.y=GH-20;p.x=Math.random()*GW;}
    }
  }
}

function drawWeather(t){
  const inf=globalEntropy/100;
  if(inf<0.4)return;

  for(const p of weatherParticles){
    if(inf>=0.8){
      // Fire embers
      const flicker=0.3+0.7*Math.sin(t/100+p.x);
      ctx.fillStyle=`rgba(255,${Math.floor(50+Math.random()*80)},0,${flicker*0.6})`;
      ctx.fillRect(p.x,p.y,1,1);
    } else if(inf>=0.4){
      // Rain
      const alpha=Math.min(1,(inf-0.4)/0.3)*0.4;
      ctx.fillStyle=`rgba(150,180,255,${alpha})`;
      ctx.fillRect(p.x,p.y,1,Math.min(3,p.speed));
    }
  }

  // Lightning flash at very high entropy
  if(inf>0.7&&Math.random()<0.003){
    ctx.fillStyle=`rgba(255,255,255,0.15)`;
    ctx.fillRect(0,0,GW,GH);
  }
}

// ===== SMOKE FROM CHIMNEYS =====
const smokeParticles=[];
function updateSmoke(t){
  // Spawn from high-infection buildings
  if(Math.random()<0.15){
    for(const b of BUILDINGS){
      const node=state?state.nodes.find(n=>n.id===b.id):null;
      const inf=(node?node.infection:50)/100;
      if(inf>0.5&&Math.random()<inf*0.3){
        smokeParticles.push({
          x:b.bx+b.w/2+Math.random()*4-2,
          y:b.by-5,
          life:60+Math.random()*40,
          maxLife:100,
          vx:(Math.random()-0.5)*0.2,
          vy:-0.3-Math.random()*0.2,
          inf:inf,
        });
      }
    }
  }
  for(let i=smokeParticles.length-1;i>=0;i--){
    const s=smokeParticles[i];
    s.x+=s.vx;s.y+=s.vy;s.life--;
    if(s.life<=0)smokeParticles.splice(i,1);
  }
}

function drawSmoke(){
  for(const s of smokeParticles){
    const alpha=(s.life/s.maxLife)*0.4;
    if(s.inf>0.7){
      ctx.fillStyle=`rgba(180,40,0,${alpha})`;
    } else {
      ctx.fillStyle=`rgba(120,120,120,${alpha})`;
    }
    ctx.fillRect(Math.floor(s.x),Math.floor(s.y),2,2);
  }
}

// ===== NEWS TICKER =====
let tickerX=GW;
let tickerText='';
let tickerTimer=0;
function updateTicker(){
  if(!state)return;
  tickerX-=0.5;
  const tw=textWidth(tickerText,1);
  if(tickerX<-tw-20){
    // Build new ticker from current trends
    const items=state.nodes
      .filter(n=>n.infection>50)
      .sort((a,b)=>b.infection-a.infection)
      .slice(0,5)
      .map(n=>`${n.name}: ${n.trend} (${n.infection}%)`);
    tickerText='BREAKING: '+items.join('  ---  ');
    tickerX=GW;
  }
}

// ===== CLICK TO INSPECT =====
let selectedBuilding=null;
let selectedAnim=0;

canvas.addEventListener('click',e=>{
  const rect=canvas.getBoundingClientRect();
  const mx=(e.clientX-rect.left)/rect.width*GW;
  const my=(e.clientY-rect.top)/rect.height*GH;

  // Check if clicked on a building
  let clicked=null;
  for(const b of BUILDINGS){
    if(mx>=b.bx-4&&mx<=b.bx+b.w+4&&my>=b.by-8&&my<=b.by+b.h+20){
      clicked=b;break;
    }
  }
  if(clicked===selectedBuilding) selectedBuilding=null; // toggle off
  else { selectedBuilding=clicked; selectedAnim=0; }
});

function drawInspectPanel(t){
  if(!selectedBuilding||!state)return;
  const node=state.nodes.find(n=>n.id===selectedBuilding.id);
  if(!node)return;

  selectedAnim=Math.min(1,selectedAnim+0.05);
  const inf=node.infection;
  const c=getColor(inf);

  // Panel slides in from right
  const panelW=130;
  const panelH=90;
  const targetX=GW-panelW-6;
  const px=GW+(targetX-GW)*selectedAnim;
  const py=26;

  // Background
  ctx.fillStyle='rgba(8,8,18,0.94)';
  ctx.fillRect(px,py,panelW,panelH);

  // Border
  ctx.strokeStyle='rgba(80,80,120,0.5)';
  ctx.lineWidth=1;
  ctx.strokeRect(px-0.5,py-0.5,panelW+1,panelH+1);

  // Accent stripe
  ctx.fillStyle=c;
  ctx.fillRect(px,py,2,panelH);

  // Close X
  drawText('X',px+panelW-8,py+3,'#666',1);

  // Name
  drawText(node.name,px+6,py+4,'#e0e0e0',1);

  // Big infection number
  drawText(inf+'%',px+6,py+14,c,2);

  // Bar
  ctx.fillStyle='#1a1a1a';
  ctx.fillRect(px+6,py+30,panelW-14,4);
  ctx.fillStyle=c;
  ctx.fillRect(px+6,py+30,Math.floor((panelW-14)*inf/100),4);

  // Status
  const status=inf>=70?'CRITICAL':inf>=50?'ELEVATED':inf>=30?'MODERATE':'STABLE';
  drawText('STATUS: '+status,px+6,py+38,inf>=70?'#e83030':'#888',1);

  // Trend
  const trend=node.trend;
  // Word wrap at ~22 chars
  const line1=trend.slice(0,22);
  const line2=trend.slice(22,44);
  drawText(line1,px+6,py+50,'#aaa',1);
  if(line2) drawText(line2,px+6,py+58,'#aaa',1);

  // Connections
  const conns=node.connections?node.connections.length:0;
  drawText(conns+' CONNECTIONS',px+6,py+70,'#555',1);

  // Highlight the selected building
  ctx.strokeStyle=c;
  ctx.lineWidth=1;
  const b=selectedBuilding;
  const pulse=0.5+0.5*Math.sin(t/300);
  ctx.globalAlpha=pulse;
  ctx.strokeRect(b.bx-3,b.by-7,b.w+6,b.h+28);
  ctx.globalAlpha=1;
}

// ===== HOVER =====
let hoverBuilding=null;
canvas.addEventListener('mousemove',e=>{
  const rect=canvas.getBoundingClientRect();
  const mx=(e.clientX-rect.left)/rect.width*GW;
  const my=(e.clientY-rect.top)/rect.height*GH;
  hoverBuilding=null;
  for(const b of BUILDINGS){
    if(mx>=b.bx-4&&mx<=b.bx+b.w+4&&my>=b.by-8&&my<=b.by+b.h+20){
      hoverBuilding=b;break;
    }
  }
  canvas.style.cursor=hoverBuilding?'pointer':'default';
});

// ===== DRAW CHARACTER (stationary, in front of building) =====
function drawChar(x,y,bodyColor,infection,t){
  const inf=infection/100;
  const bob=Math.floor(Math.sin(t/500+x)*1.5);
  let gx=0;
  if(inf>0.6&&Math.random()<inf*0.06)gx=Math.floor((Math.random()-0.5)*3);
  const dy=y+bob;
  const r=bodyColor[0],g=bodyColor[1],b=bodyColor[2];
  const cr=Math.min(255,Math.floor(r+(230-r)*inf*0.7));
  const cg=Math.floor(g*(1-inf*0.6));
  const cb=Math.floor(b*(1-inf*0.7));
  const col=`rgb(${cr},${cg},${cb})`;
  const dark=`rgb(${Math.floor(cr*0.6)},${Math.floor(cg*0.6)},${Math.floor(cb*0.6)})`;

  ctx.fillStyle='rgba(0,0,0,0.3)';ctx.fillRect(x+gx+1,dy+10,6,2);
  ctx.fillStyle=col;ctx.fillRect(x+gx+1,dy,6,5);
  ctx.fillStyle=dark;ctx.fillRect(x+gx,dy+1,1,3);ctx.fillRect(x+gx+7,dy+1,1,3);ctx.fillRect(x+gx+1,dy-1,6,1);
  if(inf>0.5){const p=0.7+0.3*Math.sin(t/200+infection);ctx.fillStyle=`rgba(255,${Math.floor(40*(1-inf))},0,${p})`;}else{ctx.fillStyle='#fff';}
  ctx.fillRect(x+gx+2,dy+2,1,1);ctx.fillRect(x+gx+5,dy+2,1,1);
  ctx.fillStyle=col;ctx.fillRect(x+gx+1,dy+5,6,4);ctx.fillRect(x+gx,dy+6,1,2);ctx.fillRect(x+gx+7,dy+6,1,2);
  ctx.fillStyle=dark;ctx.fillRect(x+gx+2,dy+9,2,2);ctx.fillRect(x+gx+5,dy+9,2,2);
  if(inf>0.7){for(let i=0;i<Math.floor(inf*6);i++){ctx.fillStyle=`rgba(255,${Math.floor(Math.random()*40)},0,${Math.random()*0.6})`;ctx.fillRect(x+gx+Math.floor(Math.random()*8),dy+Math.floor(Math.random()*10),1,1);}}
}

// ===== DRAW BUILDING =====
function drawBuilding(b,infection,t){
  const inf=infection/100;
  const wallR=Math.floor(160+inf*60),wallG=Math.floor(140*(1-inf*0.4)),wallB=Math.floor(120*(1-inf*0.5));
  ctx.fillStyle=`rgb(${wallR},${wallG},${wallB})`;ctx.fillRect(b.bx,b.by,b.w,b.h);
  ctx.fillStyle=b.roof;ctx.fillRect(b.bx-2,b.by-4,b.w+4,5);
  ctx.fillStyle='rgba(0,0,0,0.2)';ctx.fillRect(b.bx-2,b.by-4,b.w+4,1);
  ctx.fillStyle=PAL.woodDark;ctx.fillRect(b.bx+b.w/2-3,b.by+b.h-8,6,8);
  ctx.fillStyle=PAL.wood;ctx.fillRect(b.bx+b.w/2-2,b.by+b.h-7,4,7);
  if(inf>0.5){const p=0.5+0.5*Math.sin(t/300+infection);ctx.fillStyle=`rgba(255,50,0,${p*inf})`;}else{ctx.fillStyle='rgba(200,220,255,0.6)';}
  ctx.fillRect(b.bx+3,b.by+4,4,4);ctx.fillRect(b.bx+b.w-7,b.by+4,4,4);
  ctx.fillStyle=PAL.woodDark;
  ctx.fillRect(b.bx+3,b.by+5.5,4,0.5);ctx.fillRect(b.bx+4.5,b.by+4,0.5,4);
  ctx.fillRect(b.bx+b.w-7,b.by+5.5,4,0.5);ctx.fillRect(b.bx+b.w-5.5,b.by+4,0.5,4);
  if(inf>0.6){ctx.fillStyle=`rgba(60,0,0,${inf*0.5})`;for(let i=0;i<Math.floor(inf*4);i++){ctx.fillRect(b.bx+Math.floor(Math.random()*b.w),b.by+Math.floor(Math.random()*b.h),1+Math.floor(Math.random()*3),1);}}
  ctx.strokeStyle='rgba(0,0,0,0.3)';ctx.lineWidth=1;ctx.strokeRect(b.bx-0.5,b.by-0.5,b.w+1,b.h+1);
}

// ===== GROUND =====
function drawGround(t){
  const inf=globalEntropy/100;
  const skyIdx=Math.min(4,Math.floor(inf*4.5));
  ctx.fillStyle=PAL.sky[skyIdx];ctx.fillRect(0,0,GW,GH);
  if(inf>0.5){const sc=Math.floor((inf-0.5)*60);for(let i=0;i<sc;i++){const sx=(i*137+i*i*31)%GW,sy=(i*89+i*i*17)%(GH*0.3);ctx.fillStyle=`rgba(255,255,255,${(0.3+0.7*Math.sin(t/1000+i*0.5))*0.5})`;ctx.fillRect(sx,sy,1,1);}}
  for(let gx=0;gx<GW;gx+=4){for(let gy=30;gy<GH-20;gy+=4){const noise=((gx*7+gy*13)%5)/5;
    if(inf<0.3)ctx.fillStyle=PAL.grass[Math.floor(noise*3)];
    else if(inf>0.7)ctx.fillStyle=PAL.grassDead[Math.floor(noise*3)];
    else{const mix=(inf-0.3)/0.4;ctx.fillStyle=noise>mix?PAL.grass[Math.floor(noise*3)]:PAL.grassDead[Math.floor(noise*3)];}
    ctx.fillRect(gx,gy,4,4);}}
  ctx.fillStyle=PAL.path;
  ctx.fillRect(20,90,340,6);ctx.fillRect(20,165,340,6);
  ctx.fillRect(75,50,5,120);ctx.fillRect(155,45,5,125);ctx.fillRect(235,55,5,135);ctx.fillRect(310,50,5,150);
  ctx.fillStyle=PAL.pathDark;ctx.fillRect(20,96,340,1);ctx.fillRect(20,171,340,1);
}

function drawTree(x,y,inf){
  ctx.fillStyle=PAL.wood;ctx.fillRect(x+2,y+4,2,4);
  if(inf>0.6)ctx.fillStyle=`rgb(${Math.floor(180+inf*70)},${Math.floor(100*(1-inf))},30)`;
  else ctx.fillStyle='#2a8a2a';
  ctx.fillRect(x,y,6,5);ctx.fillRect(x+1,y-1,4,1);
}

// ===== SPEECH BUBBLES =====
let activeBubbles=[],bubbleTimer=0;
function updateBubbles(t){
  bubbleTimer++;
  if(bubbleTimer>180&&state){
    bubbleTimer=0;
    const b=BUILDINGS[Math.floor(Math.random()*BUILDINGS.length)];
    const node=state.nodes.find(n=>n.id===b.id);
    if(node){
      const trend=node.trend.length>20?node.trend.slice(0,18)+'..':node.trend;
      activeBubbles.push({x:b.bx+b.w/2,y:b.by-18,text:trend,life:180,max:180});
    }
    if(activeBubbles.length>3)activeBubbles.shift();
  }
}
function drawBubble(bub){
  const alpha=Math.min(1,bub.life/30);
  const tw=textWidth(bub.text,1);const bw=tw+6,bh=10;
  const bx=Math.max(2,Math.min(GW-bw-2,bub.x-bw/2));
  const by=bub.y-bub.life*0.02;
  ctx.fillStyle=`rgba(20,20,35,${0.9*alpha})`;ctx.fillRect(bx,by,bw,bh);
  ctx.strokeStyle=`rgba(80,80,120,${0.6*alpha})`;ctx.lineWidth=1;ctx.strokeRect(bx-0.5,by-0.5,bw+1,bh+1);
  ctx.fillStyle=`rgba(20,20,35,${0.9*alpha})`;ctx.fillRect(bub.x-1,by+bh,2,3);
  drawText(bub.text,bx+3,by+2,`rgba(200,200,220,${alpha})`,1);
}

// ===== MAIN LOOP =====
function drawFrame(t){
  tick=t;
  ctx.save();
  ctx.scale(SCALE,SCALE);
  if(state) globalEntropy=state.globalEntropy;
  const inf=globalEntropy/100;

  drawGround(t);

  // Trees
  const trees=[[15,75],[350,70],[5,150],[365,150],[175,75],[95,175],[280,170],[340,100]];
  for(const tr of trees)drawTree(tr[0],tr[1],inf);

  // Update systems
  updateWalkers();
  updateWeather();
  updateSmoke(t);
  updateBubbles(t);
  updateTicker();

  // Draw walkers (behind buildings)
  for(const w of walkers){
    if(w.y<110) drawWalker(w,t);
  }

  // Sort buildings by y
  const sorted=[...BUILDINGS].sort((a,b)=>(a.by+a.h)-(b.by+b.h));
  for(const b of sorted){
    const node=state?state.nodes.find(n=>n.id===b.id):null;
    const infection=node?node.infection:50;
    drawBuilding(b,infection,t);
    const charX=b.bx+b.w/2-4,charY=b.by+b.h+2;
    drawChar(charX,charY,b.color,infection,t);
    // Health bar
    ctx.fillStyle='#1a1a1a';ctx.fillRect(charX-1,charY-4,10,3);
    ctx.fillStyle=getColor(infection);ctx.fillRect(charX-1,charY-4,Math.floor(10*infection/100),3);
    ctx.strokeStyle='#333';ctx.lineWidth=1;ctx.strokeRect(charX-1.5,charY-4.5,11,4);
    // Name
    const tw=textWidth(b.name,1);
    drawText(b.name,b.bx+b.w/2-tw/2,b.by+b.h+15,'rgba(255,255,255,0.6)',1);
  }

  // Walkers in front of buildings
  for(const w of walkers){
    if(w.y>=110) drawWalker(w,t);
  }

  // Smoke
  drawSmoke();

  // Weather (rain/fire)
  drawWeather(t);

  // Speech bubbles
  for(let i=activeBubbles.length-1;i>=0;i--){
    activeBubbles[i].life--;
    if(activeBubbles[i].life<=0){activeBubbles.splice(i,1);continue;}
    drawBubble(activeBubbles[i]);
  }

  // ===== HUD =====
  ctx.fillStyle='rgba(10,10,20,0.88)';ctx.fillRect(0,0,GW,22);
  ctx.fillStyle='rgba(60,60,100,0.4)';ctx.fillRect(0,22,GW,1);
  drawText('ENTROPY',4,4,'#e0e0e0',1);
  const dotPulse=0.5+0.5*Math.sin(t/400);
  ctx.fillStyle=`rgba(230,50,50,${dotPulse})`;ctx.fillRect(56,5,3,3);
  drawText('CHAOS INDEX: ',80,4,'#666',1);
  const pctColor=getColor(globalEntropy);
  drawText(globalEntropy+'%',80+textWidth('CHAOS INDEX: ',1)+2,4,pctColor,1);
  if(state){const nc=state.totalNodes+' NODES';drawText(nc,GW-textWidth(nc,1)-4,4,'#555',1);}
  // X/Twitter icon - small clickable area top-right, below NODES
  drawText('@',GW-textWidth('@ENTROPYINDEX',1)-4,14,'#555',1);
  drawText('ENTROPYINDEX',GW-textWidth('ENTROPYINDEX',1)-4,14,'#888',1);
  drawText('LIVE',4,12,'#555',1);

  // Bottom bar with ticker
  ctx.fillStyle='rgba(10,10,20,0.88)';ctx.fillRect(0,GH-16,GW,16);
  ctx.fillStyle='rgba(60,60,100,0.4)';ctx.fillRect(0,GH-17,GW,1);
  // Ticker text
  ctx.save();
  ctx.beginPath();ctx.rect(0,GH-16,GW,16);ctx.clip();
  drawText(tickerText,Math.floor(tickerX),GH-12,'#888',1);
  ctx.restore();

  // Red overlay
  if(inf>0.7){ctx.fillStyle=`rgba(100,0,0,${(inf-0.7)*0.15})`;ctx.fillRect(0,0,GW,GH);}

  // Scanlines
  for(let sy=0;sy<GH;sy+=2){ctx.fillStyle='rgba(0,0,0,0.04)';ctx.fillRect(0,sy,GW,1);}

  // Hover tooltip
  if(hoverBuilding&&!selectedBuilding&&state){
    const node=state.nodes.find(n=>n.id===hoverBuilding.id);
    if(node){
      const c2=getColor(node.infection);const panelW=140,panelH=48;
      let px2=hoverBuilding.bx+hoverBuilding.w+6,py2=hoverBuilding.by-10;
      if(px2+panelW>GW-4)px2=hoverBuilding.bx-panelW-6;
      if(py2+panelH>GH-20)py2=GH-20-panelH;if(py2<24)py2=24;
      ctx.fillStyle='rgba(10,10,20,0.92)';ctx.fillRect(px2,py2,panelW,panelH);
      ctx.strokeStyle='rgba(80,80,120,0.6)';ctx.lineWidth=1;ctx.strokeRect(px2-0.5,py2-0.5,panelW+1,panelH+1);
      ctx.fillStyle=c2;ctx.fillRect(px2,py2,2,panelH);
      drawText(node.name,px2+6,py2+4,'#e0e0e0',1);
      ctx.fillStyle='#1a1a1a';ctx.fillRect(px2+6,py2+14,panelW-14,4);
      ctx.fillStyle=c2;ctx.fillRect(px2+6,py2+14,Math.floor((panelW-14)*node.infection/100),4);
      drawText(node.infection+'% INFECTED',px2+6,py2+22,c2,1);
      const trend=node.trend.length>24?node.trend.slice(0,22)+'..':node.trend;
      drawText(trend,px2+6,py2+32,'#888',1);
    }
  }

  // Inspect panel
  drawInspectPanel(t);

  ctx.restore();
  requestAnimationFrame(drawFrame);
}

// ===== INIT =====
initWalkers();
initWeather();

async function loadState(){
  try{const r=await fetch('world-state.json?t='+Date.now());state=await r.json();globalEntropy=state.globalEntropy;}catch(e){console.error(e);}
}
canvas.addEventListener('click',function(e){
  const rect=canvas.getBoundingClientRect();
  const sx=(e.clientX-rect.left)/rect.width*GW;
  const sy=(e.clientY-rect.top)/rect.height*GH;
  if(sx>=GW-120&&sy>=10&&sy<=22){window.open('https://x.com/entropyindex','_blank');}
});
loadState().then(()=>requestAnimationFrame(drawFrame));
setInterval(loadState,30000);
})();
</script>
</body>
</html>
